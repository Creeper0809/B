name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  build-linux:
    name: Build on Linux
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y nasm cmake build-essential
        
    - name: Add bin to PATH
      run: |
        echo "${{ github.workspace }}/bin" >> $GITHUB_PATH
        chmod +x bin/basm bin/v2c
        
    - name: Build v3 compiler
      run: |
        cmake -B build -DCMAKE_BUILD_TYPE=Release
        cmake --build build
        
    - name: Verify v3c binary
      run: |
        file bin/v3c
        ./bin/v3c --version || true
        
    - name: Run lexer golden tests
      run: |
        bash test/v3_hosted/run_lexer_golden.sh
        
    - name: Run codegen golden tests
      run: |
        bash test/v3_hosted/run_codegen_golden.sh || true
        
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: b-compiler-linux
        path: bin/v3c
        
  build-windows:
    name: Windows Environment Check
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Check Windows build prerequisites
      run: |
        echo "=== Windows Build Status ==="
        echo "NOTE: Native Windows build is not yet supported."
        echo "basm and v2c are Linux ELF binaries that cannot run on Windows."
        echo ""
        echo "Future plans:"
        echo "- Cross-compile v3c.exe from Linux using mingw-w64"
        echo "- Or rewrite basm/v2c to be cross-platform"
        echo ""
        echo "Current files in bin/:"
        dir bin
        echo ""
        echo "✅ Windows environment check passed"
        
  test-cross-platform:
    name: Cross-platform tests
    needs: [build-linux]
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Download Linux artifact
      uses: actions/download-artifact@v4
      with:
        name: b-compiler-linux
        path: bin/
        
    - name: Verify Linux build
      run: |
        ls -lh bin/
        file bin/v3c
        echo "✅ Linux build succeeded"
