name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  build-linux:
    name: Build on Linux
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y nasm cmake build-essential
        
    - name: Add bin to PATH
      run: |
        echo "${{ github.workspace }}/bin" >> $GITHUB_PATH
        chmod +x bin/basm bin/v2c
        
    - name: Build v3 compiler
      run: |
        cmake -B build -DCMAKE_BUILD_TYPE=Release
        cmake --build build
        
    - name: Verify v3c binary
      run: |
        file bin/v3c
        ./bin/v3c --version || true
        
    - name: Run lexer golden tests
      run: |
        bash test/v3_hosted/run_lexer_golden.sh
        
    - name: Run codegen golden tests
      run: |
        bash test/v3_hosted/run_codegen_golden.sh || true
        
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: b-compiler-linux
        path: bin/v3c
        
  build-windows:
    name: Build on Windows
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Install NASM
      run: |
        choco install nasm -y
        
    - name: Install mingw-w64
      run: |
        choco install mingw -y
        
    - name: Setup environment
      run: |
        echo "C:\ProgramData\chocolatey\lib\mingw\tools\install\mingw64\bin" >> $GITHUB_PATH
        echo "C:\Program Files\NASM" >> $GITHUB_PATH
        echo "${{ github.workspace }}\bin" >> $GITHUB_PATH
        
    - name: Build v3 compiler
      run: |
        cmake -B build -G "MinGW Makefiles" -DCMAKE_BUILD_TYPE=Release
        cmake --build build
        
    - name: Verify v3c binary
      run: |
        file bin/v3c.exe || true
        
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: b-compiler-windows
        path: bin/v3c.exe
        
  test-cross-platform:
    name: Cross-platform tests
    needs: [build-linux, build-windows]
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Download Linux artifact
      uses: actions/download-artifact@v4
      with:
        name: b-compiler-linux
        path: bin/
        
    - name: Download Windows artifact
      uses: actions/download-artifact@v4
      with:
        name: b-compiler-windows
        path: bin-win/
        
    - name: Compare builds
      run: |
        ls -lh bin/
        ls -lh bin-win/
        echo "âœ… Both Linux and Windows builds succeeded"
