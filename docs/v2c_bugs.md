# v2c 버그 리스트 및 해결 전략

## 발견된 주요 버그

### 1. offsetof 버그 (치명적)
**증상**: `offsetof(Struct, field)` 사용 시 segfault 또는 잘못된 오프셋 계산
**원인**: v2c의 레지스터 할당 버그 (구체적 원인 미상)
**영향**: struct 레이아웃 계산 불가
**우선순위**: 🔴 Critical

**해결 방안**:
- [ ] v2c 레지스터 할당 알고리즘 분석
- [ ] offsetof 구현 코드 단계별 디버깅
- [ ] 최소 재현 케이스 작성
- [ ] 수동 오프셋 계산으로 우회 (임시)

### 2. 연산자 우선순위 버그
**증상**: `1 + 2 * 3` = 9 (기대: 7)
**원인**: parse_add와 parse_mul이 분리되지 않음
**상태**: ✅ 수정됨 (v3_hosted에서)
**우선순위**: 🟢 Resolved

### 3. 복잡한 표현식 파싱 실패
**증상**: 중첩된 표현식에서 예상치 못한 파싱 에러
**원인**: Recursive descent parser의 상태 관리 문제
**우선순위**: 🟡 Medium

### 4. import 관련 segfault
**증상**: 특정 import 패턴에서 segfault
**원인**: 파일 경로 처리 또는 모듈 로딩 버그
**상태**: 일부 해결됨
**우선순위**: 🟡 Medium

### 5. 슬라이스 필드 접근 미지원
**증상**: `slice.len`, `slice.ptr` 컴파일 에러
**원인**: v3c_full의 타입 체크 미구현
**영향**: 슬라이스 사용 불가
**우선순위**: 🔴 Critical (v4 블로커)

---

## 새로운 개발 전략

### Phase 0: v2c 버그 수정 (Bootstrap 안정화)
**목표**: v2c가 v3 컴파일러를 안정적으로 컴파일할 수 있게 만들기

#### 0.1 offsetof 버그 수정
- [ ] v2 컴파일러 소스 분석 (src/v2/)
- [ ] offsetof 관련 코드 추적
- [ ] 레지스터 할당 알고리즘 검토
- [ ] 수정 및 테스트

#### 0.2 완전한 v3.5 컴파일러 작성
**전략**: v2c로 컴파일 가능한 문법으로 v3 전체 기능 구현

**핵심 목표**: v2c 버그(offsetof 등)에 의존하지 않고 모든 기능 지원

##### 필수 기능 (v2c로 컴파일 가능)
- [ ] **타입 시스템**
  - [ ] 기본 타입: u8/u16/u32/u64, i8/i16/i32/i64, bool, f32/f64
  - [ ] 슬라이스: `[]T` (`.len`, `.ptr` 필드 접근)
  - [ ] 배열: `[N]T`, 다차원 배열
  - [ ] 포인터: `*T`, `*T?` (nullable)
  - [ ] struct, enum
  - [ ] 함수 포인터: `func(T, U) -> R`

- [ ] **표현식/연산**
  - [ ] 산술: `+`, `-`, `*`, `/`, `%`
  - [ ] 비트: `&`, `|`, `^`, `~`, `<<`, `>>`
  - [ ] 비교: `==`, `!=`, `<`, `>`, `<=`, `>=`
  - [ ] 논리: `&&`, `||`, `!`
  - [ ] 복합 대입: `+=`, `-=`, `*=`, etc.
  - [ ] 증감: `++`, `--`
  - [ ] 인덱싱: `arr[i]`, `arr[$i]` (unsafe)
  - [ ] 필드 접근: `obj.field`, `ptr->field`
  - [ ] 함수 호출, 간접 호출

- [ ] **제어 흐름**
  - [ ] if/else
  - [ ] while, for
  - [ ] foreach (슬라이스, 배열)
  - [ ] switch (no-fallthrough)
  - [ ] break/continue (레벨 지원)
  - [ ] return

- [ ] **선언**
  - [ ] 함수, 변수, 상수
  - [ ] struct, enum
  - [ ] import (문자열 경로)
  - [ ] 접근 제어: public/private
  - [ ] impl 블록 (메서드)

- [ ] **고급 기능**
  - [ ] defer
  - [ ] 변수 섀도잉
  - [ ] 메서드 호출 설탕
  - [ ] 인라인 어셈블리: `asm { ... }`
  - [ ] alias (레지스터 별칭)

- [ ] **내장 함수**
  - [ ] print, println, panic
  - [ ] cast, sizeof
  - [ ] slice_from_ptr_len, unwrap_ptr

##### 제외 기능 (v2c 제약)
- ❌ 제네릭 `<T>` (v2c 미지원)
- ❌ comptime (v2c 미지원)
- ❌ value generics (v2c 미지원)

**크기 목표**: 3000-4000줄 (v3_hosted 9000줄의 절반)
**컴파일**: v2c로 컴파일 가능
**용도**: v4 완전 부트스트랩 + 실전 사용

#### 0.3 v3.5로 v4 컴파일러 부트스트랩
- [ ] v4 컴파일러를 v3.5 문법으로 작성 (bpp/v4/)
- [ ] v3.5로 v4 컴파일
- [ ] v4로 v4 자체 컴파일 (셀프호스팅)

---

## 작업 순서

1. **v2c offsetof 버그 분석** (1-2일)
   - 소스 코드 리뷰
   - 최소 재현 케이스
   - 수정 또는 우회

2. **v3.5 컴파일러 작성** (3-5일)
   - 슬라이스 지원
   - 최소 기능 구현
   - v2c로 컴파일 성공

3. **v4 개발 시작** (이후)
   - v3.5를 사용한 부트스트랩
   - 고급 기능 추가

---

## 현재 상태 (2026-01-10)

- ✅ v3c_full 동작 확인 (minimal.b → assembly)
- ✅ 툴체인 검증 (compile → assemble → link → run)
- ❌ 슬라이스 필드 접근 미지원 (v3c_full)
- ❌ offsetof 버그 미해결 (v2c)

**다음 단계**: v2c offsetof 버그 분석 또는 v3.5 컴파일러 작성
