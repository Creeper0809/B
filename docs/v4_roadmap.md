# v4 Roadmap (Draft)

v4는 v3(MVP)에서 의도적으로 뒤로 미룬 “블랙홀 위험 기능”을 다룹니다.
목표는 기능을 더 넣는 것보다, **컴파일러/IR/표준 라이브러리 기반이 충분히 단단해진 뒤**
고급 기능을 안전하게 확장하는 것입니다.

원칙:
- v3에서 미룬 기능은 “그냥 나중에”가 아니라, v4에서 **명시적 범위/제약/실패 모드**를 먼저 고정한다.
- 컴파일러 내부 실행기/검증/퍼징은 쉽게 규모가 커지므로, 결정성/샌드박스/리소스 제한을 최우선으로 둔다.

---

## 1) 메타프로그래밍: `comptime`

v3에서는 const-eval 수준만 유지하고, 함수 호출/루프/테이블 생성 같은 고급 `comptime`은 v4에서 다룬다.

- [ ] 문법(안): `const X = comptime f(...);`
- [ ] 예: `const CRC_TABLE = comptime gen_crc_table();`

### 1.1) 컴파일러 내장 실행기: “작은 인터프리터/제한 VM” 체크리스트

`comptime`을 함수 호출/루프까지 확장하려면 컴파일러 내부에 “실행기”가 필요해지기 쉽다.
이 실행기는 범위를 제한하지 않으면 기능/디버깅/보안/성능 면에서 블랙홀로 커질 수 있으므로,
아래 원칙을 **필수로 고정**한다.

- [ ] 결정성(Determinism)
	- [ ] I/O, 시스템콜, 시간, 스레드, 랜덤 등 비결정 요소는 comptime에서 금지(= 컴파일 에러)
	- [ ] 외부 입력이 필요한 패턴은 v3의 `@embed`/생성된 파일 포함으로 우회

- [ ] 샌드박스/리소스 제한(필수)
	- [ ] 실행 스텝 제한(예: instruction count) + 제한 초과 시 컴파일 에러
	- [ ] comptime 메모리 상한(예: N KiB/MiB) + 제한 초과 시 컴파일 에러
	- [ ] 재귀/루프 무한 실행 방지 정책(스텝 제한으로 일원화 권장)

- [ ] 허용/금지 기능(범위 최소화)
	- [ ] 허용(최소): 정수/비트 연산, 비교/분기, 지역 변수, 고정 크기 배열/슬라이스 기반 계산(단, bounds는 기본 safe)
	- [ ] 금지(기본): FFI/`extern` 호출, `asm`, OS 의존 기능, 힙 할당(초기)
	- [ ] 포인터/`*T` 관련 연산은 초기에는 comptime에서 금지하거나, “opaque 값 + 산술/역참조 금지”로 최소화
	- [ ] `$`(unsafe 우회)는 comptime에서 기본 금지(권장)

- [ ] 오류/진단
	- [ ] comptime 런타임 에러(0으로 나누기, OOB, overflow 등)는 “컴파일 에러”로 승격
	- [ ] 에러는 원인 스팬/호출 스택(가능하면)을 포함해서 보고

- [ ] 구현 형태(택1)
	- [ ] AST/IR const-eval 확장: 가능한 범위는 AST/IR 기반 평가기로 처리(권장)
	- [ ] 제한 바이트코드 VM: 필요한 경우에만 최소 명령 집합으로 VM을 추가

---

## 2) 테스트/검증 전략(v4)

v3에서는 컴파일러/IR/코드젠의 골격을 우선 완성하고,
v4에서 테스트 체계를 “자동화/확장/보안 중심”으로 강화한다.

### 2.1) 형식 검증(Formal Verification)

"테스트로는 버그가 없음을 증명할 수 없다"는 철학을 목표 기능으로 삼는다.

- [ ] Verify 백엔드: `basm verify`
	- [ ] `@[requires]`, `@[ensures]`, `@[invariant]`가 붙은 코드를 SMT-LIB 2.0 수식으로 변환
	- [ ] Z3 등 외부 solver 연동
	- [ ] 주요 타깃: overflow, 분기 조건 위반, 계약 조건 위반
- [ ] 컴파일 모드 정책
	- [ ] `verify`: 증명만 수행(실행 파일 생성 X)
	- [ ] `debug`: 계약 조건을 런타임 `assert()`로 삽입
	- [ ] `release`: 계약 조건 제거(Zero Overhead)

### 2.2) 내장 Fuzzing 및 Sanitizer

- [ ] Fuzz 블록(안): `fuzz "name" (provider) { ... }`
	- [ ] 컴파일러가 하네스/입력 주입/무한 루프 제어를 자동 생성
- [ ] Runtime Sanitizers: `-fsanitize` 옵션
	- [ ] 오버플로우, OOB, 0으로 나누기 등을 런타임에서 포착

### 2.3) 기존 테스트 체계(유지/확장)

- [ ] 파서 스냅샷 테스트(AST pretty-print golden)
- [ ] IR 스냅샷 테스트(IR dump golden)
- [ ] e2e 스모크(Px): 작은 프로그램 컴파일→실행 exit code 검증
- [ ] 제네릭/컨테이너/foreach 폭 인식 등 핵심 기능별 스모크 추가
