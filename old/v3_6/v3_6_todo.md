# v3.6 μ—…κ·Έλ μ΄λ“ TODO

## π― μµμ°μ„  μ „μ  μ΅°κ±΄

**v3.6μ—μ„ ν„μ¬ μ‚¬μ©ν•κ³  μλ” λ¨λ“  λ¬Έλ²•μ„ λ¨Όμ € κµ¬ν„ν•΄μ•Ό ν•¨**

v3.6 μ»΄νμΌλ¬λ” ν„μ¬ λ‹¤μ λ¬Έλ²•λ“¤μ„ μ‚¬μ©ν•κ³  μμΌλ©°, μ—…κ·Έλ μ΄λ“ μ „μ— μ΄ λ¨λ“  κΈ°λ¥μ΄ μ •μƒ λ™μ‘ν•΄μ•Ό ν•©λ‹λ‹¤:

### [x] ν„μ¬ v3.6 νμ„κ°€ μ²λ¦¬ν•  μ μλ” λ¬Έλ²•
- [x] **κΈ°λ³Έ νƒ€μ…**: i64, u64, u8, u16, u32, ptr (νƒ€μ… μ„ μ–Έ/μ‚¬μ©)
- [x] **λ°°μ—΄ μΈλ±μ¤ μ—°μ‚°**: `arr[index]` (ptr64[]/ptr8[] ν¬ν•¨)
- [x] **ν•¨μ νΈμ¶**: `func_name(arg1, arg2)` (vec_*, hashmap_*, str_*, sys_* λ¨λ‘)
- [x] **μ μ–΄ νλ¦„**: `if`/`else`, `while`, `for`, `foreach`, `switch`
- [x] **ν•¨μ μ •μ**: `func name(param) { }`
- [x] **κµ¬μ΅°μ²΄**: `struct S { field: type; }` (μ •μλ§, μ‹¤μ  μ‚¬μ© μ• ν•¨)
- [x] **λ¨λ“ μ‹μ¤ν…**: `import io.file;` (dotted path μ§€μ›)
- [x] **ν¬μΈν„° νƒ€μ…**: `*i64`, `**u8` (νƒ€μ… νμ‹±)
- [x] **μ£Όμ†/μ—­μ°Έμ΅°**: `&var`, `*ptr` (ν† ν°/AST νμ‹±, μ½”λ“ μƒμ„± λ¶€λ¶„ κµ¬ν„)

### [ ] v3.6 νμ„κ°€ μ•„μ§ μ²λ¦¬ν•μ§€ λ»ν•λ” λ¬Έλ²•
- [ ] **λ…μ‹μ  μΊμ¤νΈ**: `(*i64)expr`, `(*u8)ptr` β†’ νμ‹± κ·μΉ™ μ—†μ (κ΄„νΈ ν‘ν„μ‹μΌλ΅ μΈμ‹λ¨)
- [ ] **νƒ€μ… μ •λ³΄ μ¶”μ **: ν‘ν„μ‹μ νƒ€μ… κ³„μ‚° (νμ„ ν†µκ³Ό ν›„ λ¶„μ„ λ‹¨κ³„ ν•„μ”)
- [ ] **ν¬μΈν„° μ‚°μ  μλ―Έλ΅ **: `ptr + 1` (μΌλ° λ§μ…μΌλ΅ νμ‹±λμ§€λ§ sizeof κ³±μ… μ• ν•¨)
- [ ] **νƒ€μ…λ³„ λ©”λ¨λ¦¬ μ ‘κ·Ό**: `*u8` vs `*i64` (νμ‹±μ€ λμ§€λ§ μ½”λ“ μƒμ„±μ΄ 8λ°”μ΄νΈλ΅ κ³ μ •)

**λ©ν‘**: [ ] ν‘μ‹λ λ¬Έλ²•λ“¤μ„ νμ‹± κ°€λ¥ν•κ² λ§λ“¤κ³ , μ¬λ°”λ¥Έ μ½”λ“λ¥Ό μƒμ„±ν•λ„λ΅ κµ¬ν„
μ¦‰, [x] ν‘μ‹λ κΈ°λ¥λ“¤μ€ κ³„μ† μ μ§€ν•λ©΄μ„ [ ] ν‘μ‹λ κΈ°λ¥λ“¤μ„ μ¶”κ°€λ΅ κµ¬ν„ν•΄μ•Ό ν•©λ‹λ‹¤.

---

## λ©ν‘
v3.6μ„ `ptr64[]` κΈ°λ°μ—μ„ `*`, `&` κΈ°λ° ν¬μΈν„° μ‹μ¤ν…μΌλ΅ μ „ν™ν•κ³  νƒ€μ… μ‹μ¤ν… κ°•ν™”

---

## Phase 1: κΈ°λ³Έ ν¬μΈν„° λ¬Έλ²• μ¶”κ°€ β… (μ΄λ―Έ λ¶€λ¶„ κµ¬ν„λ¨)

### 1.1 λ ‰μ„ (Lexer)
- [x] `&` (μ£Όμ† μ—°μ‚°μ) - TOKEN_AMPERSAND μμ
- [x] `*` (μ—­μ°Έμ΅°/ν¬μΈν„° νƒ€μ…) - TOKEN_STAR μμ
- [x] `(` `)` (μΊμ¤νΈμ©) - TOKEN_LPAREN/RPAREN μμ

### 1.2 νμ„ (Parser)
- [x] ν¬μΈν„° νƒ€μ… νμ‹±: `*i64`, `**u8` λ“±
  - `parse_type()` μ΄λ―Έ κµ¬ν„λ¨
- [x] μ£Όμ† μ—°μ‚°μ: `&ident`
  - `parse_primary()`μ— μ΄λ―Έ κµ¬ν„λ¨
- [x] μ—­μ°Έμ΅°: `*expr`
  - `parse_primary()`μ— μ΄λ―Έ κµ¬ν„λ¨

---

## Phase 2: λ…μ‹μ  μΊμ¤νΈ λ¬Έλ²• μ¶”κ°€ β…

### 2.1 ν† ν° μ¶”κ°€
- [x] νƒ€μ… μΊμ¤νΈ λ¬Έλ²• κ²°μ •
  - μ„ νƒ: `(*i64)expr` (C μ¤νƒ€μΌ)
  - νμ‹±: `(` + type + `)` + expr

### 2.2 AST λ…Έλ“
- [x] `AST_CAST` λ…Έλ“ μ¶”κ°€ (AST_CAST = 108)
  - κµ¬μ΅°: `[kind, expr, target_type, target_ptr_depth]` (32 bytes)

### 2.3 νμ„ μμ •
- [x] `parse_primary()`μ—μ„ μΊμ¤νΈ κ°μ§€
  - `(` λ‹¤μμ— νƒ€μ…μ΄ μ¤λ”μ§€ ν™•μΈ
  - νƒ€μ…μ΄λ©΄ μΊμ¤νΈ, μ•„λ‹λ©΄ κ΄„νΈ ν‘ν„μ‹
- [x] μΊμ¤νΈ νμ‹± κµ¬ν„
  - TOKEN_STAR, TOKEN_U8, TOKEN_U16, TOKEN_U32, TOKEN_U64, TOKEN_I64 κ°μ§€

### 2.4 μ½”λ“ μƒμ„±
- [x] `cg_expr()`μ— `AST_CAST` μΌ€μ΄μ¤ μ¶”κ°€
  - ν„μ¬ no-op (λ‚΄λ¶€ ν‘ν„μ‹λ§ ν‰κ°€)
  - νƒ€μ… μ •λ³΄λ” `get_expr_type()`μ—μ„ ν™μ©

---

## Phase 3: ν¬μΈν„° μ‚°μ  (C μ¤νƒ€μΌ) β…

### 3.1 ν„μ¬ μƒνƒ
```b
// v3.6 ν„μ¬
ptr64[addr + 8]  // μλ™ μ¤ν”„μ…‹ κ³„μ‚°

// λ©ν‘
var p: *i64;
*(p + 1)  // μλ™μΌλ΅ p + 8 κ³„μ‚°
```

### 3.2 κµ¬ν„
- [x] ν‘ν„μ‹ νƒ€μ… μ¶”μ  μ‹μ¤ν…
  - `get_expr_type(node)` ν•¨μ κµ¬ν„
  - AST_IDENT, AST_CAST, AST_ADDR_OF, AST_DEREF, AST_LITERAL μ§€μ›

- [x] ν¬μΈν„° μ‚°μ  μ½”λ“ μƒμ„±
  - AST_BINARYμ—μ„ ν¬μΈν„° νƒ€μ… ν™•μΈ
  - `imul rbx, <pointee_size>` μƒμ„±

- [x] νƒ€μ…λ³„ ν¬κΈ° λ§¤ν•‘
  - `get_type_size(base_type, ptr_depth)` κµ¬ν„
  - `get_pointee_size(base_type, ptr_depth)` κµ¬ν„

- [x] νƒ€μ… μ „ν (Type Propagation)
  - λ€μ…λ¬Έμ—μ„ μ°μΈ΅ νƒ€μ…μ΄ ν¬μΈν„°λ©΄ μΆμΈ΅ λ³€μμ νƒ€μ… μ—…λ°μ΄νΈ
  - `symtab_update_type()` ν•¨μ μ¶”κ°€

---

## Phase 4: μ•”λ¬µμ  ν•λ³€ν™ β…

### 4.1 λ³€ν™ κ·μΉ™ (κ΄€λ€ν• μ‹μ¤ν…)
```
μ •μ <-> μ •μ:  ν•­μƒ OK (u8, i64 λ“±)
μ •μ <-> ν¬μΈν„°: ν•­μƒ OK (μ£Όμ†κ°’μΌλ΅ μ·¨κΈ‰)
ν¬μΈν„° <-> ν¬μΈν„°: ν•­μƒ OK (*i64 <-> *u8)
```

### 4.2 κµ¬ν„
- [x] νƒ€μ… νΈν™μ„± κ²€μ‚¬ ν•¨μ μ¶”κ°€
  - `check_type_compat(from_base, from_depth, to_base, to_depth)`
  - λ°ν™κ°’: 0=μ •ν™•ν μΌμΉ, 1=νΈν™(κ²½κ³ ), 2=λΉ„νΈν™
- [x] κ²½κ³  μ¶λ ¥ ν•¨μ μ¶”κ°€ (stderrλ΅ μ¶λ ¥)
  - `warn(msg, len)` - "[WARN] " μ ‘λ‘μ–΄λ΅ λ©”μ‹μ§€ μ¶λ ¥
  - `emit_stderr()`, `emit_stderr_nl()` ν—¬νΌ ν•¨μ
- [x] νƒ€μ… μ΄λ¦„ ν•¨μ μ¶”κ°€
  - `get_type_name(base_type, ptr_depth)` - λ””λ²„κΉ…/κ²½κ³ μ©
- [x] λ€μ…λ¬Έ(AST_ASSIGN) νƒ€μ… κ²€μ‚¬
  - μΆμΈ΅ λ³€μ νƒ€μ…κ³Ό μ°μΈ΅ ν‘ν„μ‹ νƒ€μ… λΉ„κµ
  - νΈν™λμ§€λ§ μ •ν™•ν μΌμΉν•μ§€ μ•μΌλ©΄ κ²½κ³  μ¶λ ¥
- [x] λ³€μ μ„ μ–Έ(AST_VAR_DECL) νƒ€μ… κ²€μ‚¬
  - μ„ μ–Έλ νƒ€μ…κ³Ό μ΄κΈ°ν™” κ°’ νƒ€μ… λΉ„κµ

### 4.3 ν…μ¤νΈ κ²°κ³Ό
```
$ ./bin/v3_6 test/v3_6/type_check_test.b > build/type_check_test.asm
[WARN] implicit type conversion in assignment  # b: u8 = 256 (i64)
[WARN] implicit type conversion in assignment  # q: *u8 = (*i64)arr
```

---

## Phase 5: μ—­μ°Έμ΅° μ½κΈ°/μ“°κΈ° κ°μ„  β…

### 5.1 ν„μ¬ μƒνƒ
```b
// v3.6
ptr64[addr] = value;      // μ“°κΈ°
var x = ptr64[addr];      // μ½κΈ°
```

### 5.2 λ©ν‘
```b
// μƒ λ¬Έλ²•
*ptr = value;             // μ“°κΈ°
var x = *ptr;             // μ½κΈ°
```

### 5.3 κµ¬ν„
- [x] μ—­μ°Έμ΅° lvalue μ²λ¦¬
  - `cg_lvalue()`μ—μ„ `AST_DEREF` μΌ€μ΄μ¤
  - μ£Όμ†λ¥Ό κ·Έλ€λ΅ λ°ν™ (μ΄λ―Έ κµ¬ν„λ¨!)

- [x] νƒ€μ… ν¬κΈ°μ— λ”°λ¥Έ λ©”λ¨λ¦¬ μ½κΈ°
  ```
  *u8  -> movzx rax, byte [rax]
  *u16 -> movzx rax, word [rax]
  *u32 -> mov eax, [rax]
  *i64 -> mov rax, [rax]
  ```

- [x] νƒ€μ… ν¬κΈ°μ— λ”°λ¥Έ λ©”λ¨λ¦¬ μ“°κΈ°
  ```
  *u8  -> mov [rax], bl
  *u16 -> mov [rax], bx
  *u32 -> mov [rax], ebx
  *i64 -> mov [rax], rbx
  ```

- [x] `get_expr_type()`μ— AST_BINARY μΌ€μ΄μ¤ μ¶”κ°€
  - ν¬μΈν„° + μ •μ β†’ κ°™μ€ ν¬μΈν„° νƒ€μ… λ°ν™
  - `*(p8 + 1)` κ°™μ€ ν‘ν„μ‹μ—μ„ νƒ€μ… μ¬λ°”λ¥΄κ² μ¶”λ΅ 

---



## Phase 7: μ¶”κ°€ κ°μ„  (μ„ νƒ) π―

### 7.1 νƒ€μ… μ¶”λ΅ 
- [ ] `var x = expr;` β†’ νƒ€μ… μλ™ κ²°μ •
- [ ] ν•¨μ λ°ν™ νƒ€μ… μ¶”λ΅ 

### 7.2 νƒ€μ… λ³„μΉ­
```b
type String = *u8;
type IntPtr = *i64;
```

### 7.3 μ—λ¬ λ©”μ‹μ§€ κ°μ„ 
- [ ] νƒ€μ… λ¶μΌμΉ κ²½κ³ 
- [ ] λΌμΈ/μ»¬λΌ μ •λ³΄ ν¬ν•¨

---

## κµ¬ν„ μ°μ„ μμ„

### π”¥ Critical (λ°λ“μ‹ ν•„μ”)
1. **Phase 2**: λ…μ‹μ  μΊμ¤νΈ `(*i64)expr`
2. **Phase 3**: ν¬μΈν„° μ‚°μ  (C μ¤νƒ€μΌ)
3. **Phase 5**: μ—­μ°Έμ΅° νƒ€μ…λ³„ λ©”λ¨λ¦¬ μ ‘κ·Ό

### β΅ Important (μ¤‘μ”)
4. **Phase 4**: μ•”λ¬µμ  ν•λ³€ν™
5. **Phase 6**: κΈ°μ΅΄ μ½”λ“ λ§μ΄κ·Έλ μ΄μ…

### π’΅ Nice to Have (μμΌλ©΄ μΆ‹μ)
6. **Phase 7**: μ¶”κ°€ κ°μ„  μ‚¬ν•­

---

## μμƒ μ‘μ—… μ‹κ°„

| Phase | μ‘μ—… | μμƒ μ‹κ°„ |
|-------|------|----------|
| Phase 2 | μΊμ¤νΈ λ¬Έλ²• | 2-3μ‹κ°„ |
| Phase 3 | ν¬μΈν„° μ‚°μ  | 2-3μ‹κ°„ |
| Phase 4 | μ•”λ¬µμ  ν•λ³€ν™ | 1-2μ‹κ°„ |
| Phase 5 | μ—­μ°Έμ΅° κ°μ„  | 1-2μ‹κ°„ |
| Phase 6 | λ§μ΄κ·Έλ μ΄μ… | 5-8μ‹κ°„ |
| **ν•©κ³„** | | **11-18μ‹κ°„** |

---

## λ‹¤μ λ‹¨κ³„

**μ§€κΈ λ°”λ΅ μ‹μ‘:**
1. Phase 2 (μΊμ¤νΈ) κµ¬ν„
2. Phase 3 (ν¬μΈν„° μ‚°μ ) κµ¬ν„
3. κ°„λ‹¨ν• ν…μ¤νΈλ΅ κ²€μ¦

**μ–Έμ λ“  λ¬Όμ–΄λ³΄μ„Έμ”!** π€
